package com.jatismobile.plugin.iso8583.examples;

import java.io.*;
import java.net.*;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.Date;

import org.apache.commons.io.IOUtils;
import org.bouncycastle.util.encoders.Hex;
import org.jpos.iso.ISOException;
import org.jpos.iso.ISOMsg;
import org.jpos.iso.ISOPackager;
import org.jpos.iso.packager.GenericPackager;
import org.jpos.iso.packager.ISO93APackager;

import com.jatismobile.plugin.iso8583.utils.ISOHeader;

public class Provider {
	ServerSocket providerSocket;
	Socket connection = null;
	// DataOutputStream out;
	OutputStream out;
	String message;
	private DataInputStream in;

	public Provider() {
	}

	@SuppressWarnings("deprecation")
	public
	void run() throws Exception {
		try {
			System.out.println("===========listening==========");
			// 1. creating a server socket
			providerSocket = new ServerSocket(1423, 100);
			// 2. Wait for connection
			System.out.println("Waiting for connection");
			connection = providerSocket.accept();

			System.out.println("Connection received from " + connection.getInetAddress().getHostName());
			// 3. get Input and Output streams
			out = new DataOutputStream(connection.getOutputStream());
			out.flush();

			out = new DataOutputStream(connection.getOutputStream());
			out.flush();

			in = new DataInputStream(connection.getInputStream());

			String ss = readFully2(in);

			GenericPackager packager = new GenericPackager("fields.xml");

			ISOMsg isoMsg = new ISOMsg();
			isoMsg.setPackager(packager);
			isoMsg.unpack(ss.getBytes());
			// isoMsg.set(39,"00");

			System.out.println("CMTI : " + isoMsg.getMTI());
			System.out.println("CHeader : " + isoMsg.getHeader());
			System.out.println("CISO 48 : " + isoMsg.getString(48));
			// System.out.println("CTrailer : " + isoMsg.getTrailer());
			
			Date date = new Date();
			
			ISOMsg resp = (ISOMsg) isoMsg.clone();
			if (isoMsg.getString(3).toString().equals("380000")) {
			
			resp.setPackager(packager);
//			String tt = "0210723A40010AC18018061340033800000000000825000801171244319190171244080108026012030080367422897210054JATIS12012111111111111808880001286064617010001286064617   00000008000000002500011541236         8888801286064617ONY SUDARSIH                  0903  JAKARTA TIMUR       000000080000000000080000000000000000360000000";
//			String tt = "0210723A40010AC180180613400317000000000007900007171656321950201656320717071860120300875352929766900DEVJATIS2009001008000004288888801016627488010001016627488   00000007650000002500031895482         8888801016627488FATKHUROHMAN                  1101  SEMARANG            0000000255000000000255000000000000001895480         8888801016627499ANIK SULASTRI                 1101  SEMARANG            0000000255000000000255000000000000001895481         8888801016627501DIMAS SAPUTRO                 1101  SEMARANG            000000025500000000025500000000000000360000000";
//			String tt = "0210723A40010AC180000606400238000000000021500008301222027093851222020830083160120300894132932088300DEVJATIS200900100800000166000108213113300   Test' halo3bln.               4ACA80D5CC85C9D3F5F09B0AFAE1C45E30000100000000000704A       000000051000703A       000000082000702A       000000081000360";
			String tt = "0210723A40010AC180180613400317000000000142150009291831506419641831500929093060120300840213278794800DEVJATIS2009001008000009998888801089107471010001016581342   00000141900000002500211895795         8888801016581342SOIMAH                        1101  SEMARANG            0000000510000000000510000000000000001895813         8888801016590432RATMINI                       1101  SEMARANG            0000000800000000000800000000000000001895815         8888801016592614SALBIYAH                      1101  SEMARANG            0000000800000000000800000000000000001895814         8888801016592625KURNIASIH                     1101  SEMARANG            0000000800000000000800000000000000001895820         8888801016601298NASIKIN                       1101  SEMARANG            0000000510000000000510000000000000001895821         8888801016605012MERINA ANGGI R                1101  SEMARANG            0000000510000000000510000000000000001895479         8888801016607936WARSITI                       1101  SEMARANG            0000000595000000000595000000000000001895801         8888801016610502KUSTINAH                      1101  SEMARAN360999G            0000000800000000000800000000000000001895811         8888801016617498YUNI ASTUTI                   1101  SEMARANG            0000000510000000000510000000000000001895799         8888801016634284RASIKEM                       1101  SEMARANG            0000000800000000000800000000000000001895798         8888801016635814KUSTI                         1101  SEMARANG            0000000800000000000800000000000000001895797         8888801016635825ARIFIN                        1101  SEMARANG            0000000800000000000800000000000000001895796         8888801016635836AAN FATUROHMAN                1101  SEMARANG            0000000800000000000800000000000000001895469         8888801058669818IGNASIUS BEKO                 1101  SEMARANG            0000000595000000000595000000000000001895470         8888801058669842ENJELINA NOVIA MALI           1101  SEMARANG            0000000595000000000595000000000000001895790         8888801089107346DONNY INDRA LESMANA           0605  LUBUK LINGGAU 662      0000000800000000000800000000000000001895729         8888801089107471MUH ARMIN                     1403  BARITO UTARA        0000001600000000001600000000000000001895523         8888801089107796NURQHAIDAH PURNAMASARI        0905  JAKARTA UTARA       0000000255000000000255000000000000001895842         8888801089108066ADERIAN                       0701  BENGKULU            0000000800000000000800000000000000001895474         8888801089108088M. YASIN                      0701  BENGKULU            0000000255000000000255000000000000001895560         8888801089110215H AHMAD NUR HASAN S KOM       0904  JAKARTA BARAT       000000025500000000025500000000000000";
			String aa = "0210723A40010AC180180613400317000000000142150009292206584277872206580929093060120300858792304807300DEVJATIS2009001008000009998888801089107471010001016581342   00000141900000002500211895795         8888801016581342SOIMAH                        1101  SEMARANG            0000000510000000000510000000000000001895813         8888801016590432RATMINI                       1101  SEMARANG            0000000800000000000800000000000000001895815         8888801016592614SALBIYAH                      1101  SEMARANG            0000000800000000000800000000000000001895814         8888801016592625KURNIASIH                     1101  SEMARANG            0000000800000000000800000000000000001895820         8888801016601298NASIKIN                       1101  SEMARANG            0000000510000000000510000000000000001895821         8888801016605012MERINA ANGGI R                1101  SEMARANG            0000000510000000000510000000000000001895479         8888801016607936WARSITI                       1101  SEMARANG            0000000595000000000595000000000000001895801         8888801016610502KUSTINAH                      1101  SEMARAN360999G            0000000800000000000800000000000000001895811         8888801016617498YUNI ASTUTI                   1101  SEMARANG            0000000510000000000510000000000000001895799         8888801016634284RASIKEM                       1101  SEMARANG            0000000800000000000800000000000000001895798         8888801016635814KUSTI                         1101  SEMARANG            0000000800000000000800000000000000001895797         8888801016635825ARIFIN                        1101  SEMARANG            0000000800000000000800000000000000001895796         8888801016635836AAN FATUROHMAN                1101  SEMARANG            0000000800000000000800000000000000001895469         8888801058669818IGNASIUS BEKO                 1101  SEMARANG            0000000595000000000595000000000000001895470         8888801058669842ENJELINA NOVIA MALI           1101  SEMARANG            0000000595000000000595000000000000001895790         8888801089107346DONNY INDRA LESMANA           0605  LUBUK LINGGAU 662      0000000800000000000800000000000000001895729         8888801089107471MUH ARMIN                     1403  BARITO UTARA        0000001600000000001600000000000000001895523         8888801089107796NURQHAIDAH PURNAMASARI        0905  JAKARTA UTARA       0000000255000000000255000000000000001895842         8888801089108066ADERIAN                       0701  BENGKULU            0000000800000000000800000000000000001895474         8888801089108088M. YASIN                      0701  BENGKULU            0000000255000000000255000000000000001895560         8888801089110215H AHMAD NUR HASAN S KOM       0904  JAKARTA BARAT       000000025500000000025500000000000000";
			
			resp.unpack(tt.getBytes());
			resp.set(60, resp.getString(62));
			resp.set(61, resp.getString(62));
			System.out.println("484848484848484848 : " + resp.getString(48));
			System.out.println("4444444444 : " + resp.getString(4));
			System.out.println("6262626262626262 : " + resp.getString(62));
			System.out.println("6363636363636363 : " + resp.getString(63));
			System.out.println("kampret : " + resp.getString(49));
			System.out.println(new String(resp.pack()));
			System.out.println(new String(resp.pack()));
//			resp.setResponseMTI();
//			resp.set(4, "000000654500");
//			resp.set(39, "00");
//			resp.set(48,
//					"8888801835277671110001835277671   00000196350000002500031892575         8888801835277671MEIRA                         0901  JAKARTA PUSAT       0000006545000000000595000000005950001892576         8888801835277682JOKO                          0901  JAKARTA PUSAT       0000006545000000000595000000005950001892577         8888801835277693ANEE                          0901  JAKARTA PUSAT       000000654500000000059500000000595000");
//					"0000000062155293010000062155293   00000002550000002500011891288         8888800062155293RIZAL AN NAHL                 1005  SUKABUMI            000000025500000000025500000000000000");
//			resp.set(60,
//					"0000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA");
			}
			else if (isoMsg.getString(3).toString().equals("170000")) {
				resp.setPackager(packager);
//				String tt = "0210723A40010AC1801E0613400317000000000007900007171657441950201657440717071860120300838976604079100DEVJATIS2009001008000004748888801016627488010001016627488   0000000765000000250054EE84010A72D24982350B537DB3A50D031895482         8888801016627488FATKHUROHMAN                  1101  SEMARANG            0000000255000000000255000000000000001895480         8888801016627499ANIK SULASTRI                 1101  SEMARANG            0000000255000000000255000000000000001895481         8888801016627501DIMAS SAPUTRO                 1101  SEMARANG            00000002550000000002550000000000000020170717165807360000000057Rincian tagihan dapat diakses di www.bpjs-kesehatan.go.id134JTSMOBILE                       INFORMASI TEKNOLOGI INDONESIA Jl. Mampang Prapatan No.3 Jakarta 12790           0217940946        3174";
//				String tt = "0210723A40010AC1801E061340031700000000000825000801171334319190171334080108026012030083196601881020054JATIS12012111111111112268880001286064617010001286064617   00000008000000002500C9790DE69AA523CF09448F0698D3BC82011541236         8888801286064617ONY SUDARSIH                  0903  JAKARTA TIMUR       00000008000000000008000000000000000020170801171334360000000057Rincian tagihan dapat diakses di www.bpjs-kesehatan.go.id134JTSMOBILE                       INFORMASI TEKNOLOGI INDONESIA Jl. Mampang Prapatan No.3 Jakarta 12790           0217940946        3174";
//				String tt = "0210723A40010AC180080606400217000000000021500008301222027093851222410830083160120300894132932088300DEVJATIS200900100800000180000108213113300   Test' halo3bln.               4ACA80D5CC85C9D3F5F09B0AFAE1C45E30000100000000000704A       000000051000703A       000000082000702A       00000008100020170830122309360001 ";
				String tt = "0210723A40010AC1801E061340031700000000003225001026005357661255005357102610276012030083386390556280054JATIS12012111111111115988888801327084514020001327084514   000000320000000025003B7A0C81DD97DFD9633A2B0148478AC6043676629         8888801327084514IMRAN YABIE                   2002  LUWUK               0000000800000000000000000000000800003676680         8888801327085289MIMIN SUHERMIN                2002  LUWUK               00000008000000000000000000000008000017440475        8888801958761034yogi pratama yabie            2002  LUWUK               00000008000000000000000000000008000017440526        8888801958761686febrina dwi utami yabie       2002  LUWUK               00000008000000000000000000000008000020171026005357360000000057Rincian tagihan dapat diakses di www.bpjs-kesehatan.go.id134JTSMOBILE                       INFORMASI TEKNOLOGI INDONESIA Jl. Mampang Prapatan No.3 Jakarta 12790           0217940946        3174";
				
//				String tt = "0210723A40010AC180180613400317000000000142150009292206584277872206580929093060120300858792304807300DEVJATIS2009001008000009998888801089107471010001016581342   00000141900000002500JPAREFNUJPAREFNUJPAREFNUJPAREFNU211895795         8888801016581342SOIMAH                        1101  SEMARANG            0000000510000000000510000000000000001895813         8888801016590432RATMINI                       1101  SEMARANG            0000000800000000000800000000000000001895815         8888801016592614SALBIYAH                      1101  SEMARANG            0000000800000000000800000000000000001895814         8888801016592625KURNIASIH                     1101  SEMARANG            0000000800000000000800000000000000001895820         8888801016601298NASIKIN                       1101  SEMARANG            0000000510000000000510000000000000001895821         8888801016605012MERINA ANGGI R                1101  SEMARANG            0000000510000000000510000000000000001895479         8888801016607936WARSITI                       1101  SEMARANG            0000000595000000000595000000000000001895801         8888801016610502KUSTINAH                      1101  SEMARAN360999G            0000000800000000000800000000000000001895811         8888801016617498YUNI ASTUTI                   1101  SEMARANG            0000000510000000000510000000000000001895799         8888801016634284RASIKEM                       1101  SEMARANG            0000000800000000000800000000000000001895798         8888801016635814KUSTI                         1101  SEMARANG            0000000800000000000800000000000000001895797         8888801016635825ARIFIN                        1101  SEMARANG            0000000800000000000800000000000000001895796         8888801016635836AAN FATUROHMAN                1101  SEMARANG            0000000800000000000800000000000000001895469         8888801058669818IGNASIUS BEKO                 1101  SEMARANG            0000000595000000000595000000000000001895470         8888801058669842ENJELINA NOVIA MALI           1101  SEMARANG            0000000595000000000595000000000000001895790         8888801089107346DONNY INDRA LESMANA           0605  LUBUK LINGGAU 662      0000000800000000000800000000000000001895729         8888801089107471MUH ARMIN                     1403  BARITO UTARA        0000001600000000001600000000000000001895523         8888801089107796NURQHAIDAH PURNAMASARI        0905  JAKARTA UTARA       0000000255000000000255000000000000001895842         8888801089108066ADERIAN                       0701  BENGKULU            0000000800000000000800000000000000001895474         8888801089108088M. YASIN                      0701  BENGKULU            0000000255000000000255000000000000001895560         8888801089110215H AHMAD NUR HASAN S KOM       0904  JAKARTA BARAT       000000025500000000025500000000000000";
				
//				Thread.sleep(31000);
				resp.unpack(tt.getBytes());
//				resp.set(48, "888880128606461701");
//				System.out.println("48 req : " + isoMsg.getString(48));
//				resp.set(60, resp.getString(127));
//				System.out.println("TRX_AMOUNT : " + resp.getString(4));
//				System.out.println("6060660 : " + resp.getString(60));
//				System.out.println("field data : " + resp.getString(48) + resp.getString(60) + resp.getString(61));
				resp.set(48, "8888801089107471010001016581342   00000141900000002500JPAREFNUJPAREFNUJPAREFNUJPAREFNU211895795         8888801016581342SOIMAH                        1101  SEMARANG            0000000510000000000510000000000000001895813         8888801016590432RATMINI                       1101  SEMARANG            0000000800000000000800000000000000001895815         8888801016592614SALBIYAH                      1101  SEMARANG            0000000800000000000800000000000000001895814         8888801016592625KURNIASIH                     1101  SEMARANG            0000000800000000000800000000000000001895820         8888801016601298NASIKIN                       1101  SEMARANG            0000000510000000000510000000000000001895821         8888801016605012MERINA ANGGI R                1101  SEMARANG            0000000510000000000510000000000000001895479         8888801016607936WARSITI                       1101  SEMARANG            0000000595000000000595000000000000001895801         8888801016610502KUSTINAH   ");
				resp.set(60, "                   1101  SEMARANG            0000000800000000000800000000000000001895811         8888801016617498YUNI ASTUTI                   1101  SEMARANG            0000000510000000000510000000000000001895799         8888801016634284RASIKEM                       1101  SEMARANG            0000000800000000000800000000000000001895798         8888801016635814KUSTI                         1101  SEMARANG            0000000800000000000800000000000000001895797         8888801016635825ARIFIN                        1101  SEMARANG            0000000800000000000800000000000000001895796         8888801016635836AAN FATUROHMAN                1101  SEMARANG            0000000800000000000800000000000000001895469         8888801058669818IGNASIUS BEKO                 1101  SEMARANG            0000000595000000000595000000000000001895470         8888801058669842ENJELINA NOVIA MALI           1101  SEMARANG            0000000595000000000595000000000000001895790         8888801089107346DONNY INDRA LESMAN");
				resp.set(61, "A           0605  LUBUK LINGGAU       0000000800000000000800000000000000001895729         8888801089107471MUH ARMIN                     1403  BARITO UTARA        0000001600000000001600000000000000001895523         8888801089107796NURQHAIDAH PURNAMASARI        0905  JAKARTA UTARA       0000000255000000000255000000000000001895842         8888801089108066ADERIAN                       0701  BENGKULU            0000000800000000000800000000000000001895474         8888801089108088M. YASIN                      0701  BENGKULU            0000000255000000000255000000000000001895560         8888801089110215H AHMAD NUR HASAN S KOM       0904  JAKARTA BARAT       00000002550000000002550000000000000020171102113714");
				resp.set(7, new SimpleDateFormat("MMddHHmmss").format(date));
				resp.set(62, "Rincian tagihan dapat diakses di www.bpjs-kesehatan.go.id");
				resp.set(63, "JTSMOBILE                       INFORMASI TEKNOLOGI INDONESIA Jl. Mampang Prapatan No.3 Jakarta 12790           0217940946        3174");
				resp.setPackager(packager);
			}
			else if (isoMsg.getString(3).toString().equals("171000")) {
				resp.setPackager(packager);
				String tt = "0210723A40010AC1801E061340031700000000003225001026005357661255005357102610276012030083386390556280054JATIS12012111111111115988888801327084514020001327084514   000000320000000025003B7A0C81DD97DFD9633A2B0148478AC6043676629         8888801327084514IMRAN YABIE                   2002  LUWUK               0000000800000000000000000000000800003676680         8888801327085289MIMIN SUHERMIN                2002  LUWUK               00000008000000000000000000000008000017440475        8888801958761034yogi pratama yabie            2002  LUWUK               00000008000000000000000000000008000017440526        8888801958761686febrina dwi utami yabie       2002  LUWUK               00000008000000000000000000000008000020171026005357360000000057Rincian tagihan dapat diakses di www.bpjs-kesehatan.go.id134JTSMOBILE                       INFORMASI TEKNOLOGI INDONESIA Jl. Mampang Prapatan No.3 Jakarta 12790           0217940946        3174";
				resp.unpack(tt.getBytes());
				System.out.println("TRX_AMOUNT : " + resp.getString(4));
				System.out.println("field data : " + resp.getString(48) + resp.getString(60) + resp.getString(61));
				resp.set(7, new SimpleDateFormat("MMddHHmmss").format(date));
				resp.setPackager(packager);
			}

			writeFully3(out, resp);
		} catch (IOException ioException) {
//			ioException.printStackTrace();
			connection = providerSocket.accept();
		} finally {
			// 4: Closing connection
			try {
				// Thread.sleep(5000);
				in.close();
				out.close();
				providerSocket.close();
			} catch (IOException ioException) {
				ioException.printStackTrace();
			}
		}
	}

	void sendMessage(String msg) {
		try {
			// byte[] ss = msg.getBytes();
//			 out.write("0200623A400108C1800006134003380000061411053289049011053206140615601203008675813758656DEVJATIS200900100800000018888880125679873305360".getBytes());
			// out.writeUTF(msg);
			out.flush();
			System.out.println("server>" + (msg));
		} catch (IOException ioException) {
			ioException.printStackTrace();
		}
	}

	public static String writeFully(OutputStream output) {
		byte[] buffer = "�0210623A40010AC180000613400338000000201706238904900925070623061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA360"
				.getBytes(StandardCharsets.UTF_8);
		// byte[] buffer = {87,64,72,31,90};
		try {
			DataOutputStream dataOutput = new DataOutputStream(output);
			try {
				// buffer = new byte[dataOutput.size()];
				dataOutput.write(buffer, 1, buffer.length - 1);
				dataOutput.flush();
			} finally {
				// dataOutput.close();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}

		return null;
	}

	public static String writeFully2(OutputStream output) {
		byte[] buffer = "�0210623A40010AC180000613400338000000201706238904900819060623061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA360"
				.getBytes(StandardCharsets.UTF_8);
		// byte[] buffer = {87,64,72,31,90};
		try {
			OutputStream dataOutput = output;
			try {
				// buffer = new byte[dataOutput.size()];
				dataOutput.write(buffer, 0, buffer.length - 0);
				// dataOutput.writeChars("�0210623A40010AC180180613400338000000201706228904902357380622061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518
				// 00000172050000002500151895794 8988801089110518TANTY LESTARI
				// 0905 JAKARTA UTARA
				// 0000000510000000000510000000000000001895812
				// 8988801089110676RAHMAT ARIEF 1808 LUWU
				// 0000000800000000000800000000000000001891591
				// 8988801215305289SITI CARYATI 0903 JAKARTA TIMUR
				// 0000000425000000000425000000000000001891854
				// 8988801228222732SRI TITIEK INDRAWATI 0902 JAKARTA SELATAN
				// 0000000425000000000425000000000000001125877
				// 8988801255971971SDF 0401 PEKANBARU
				// 0000000935000000000935000000000000001696724
				// 8988801256652461HARYATI 1201 YOGYAKARTA
				// 0000002975000000002975000000000000001696957
				// 8988801256654248MA'MUROTUN 0902 JAKARTA SELATAN
				// 0000004165000000004165000000000000001697213
				// 8988801256656498SUPRIYADI 0902
				// JAKARTA3609990000001089110518010001089110518
				// 00000172050000002500151895794 8988801089110518TANTY LESTARI
				// 0905 JAKARTA UTARA
				// 0000000510000000000510000000000000001895812
				// 8988801089110676RAHMAT ARIEF 1808 LUWU
				// 0000000800000000000800000000000000001891591
				// 8988801215305289SITI CARYATI 0903 JAKARTA TIMUR
				// 0000000425000000000425000000000000001891854
				// 8988801228222732SRI TITIEK INDRAWATI 0902 JAKARTA SELATAN
				// 0000000425000000000425000000000000001125877
				// 8988801255971971SDF 0401 PEKANBARU
				// 0000000935000000000935000000000000001696724
				// 8988801256652461HARYATI 1201 YOGYAKARTA
				// 0000002975000000002975000000000000001696957
				// 8988801256654248MA'MUROTUN 0902 JAKARTA SELATAN
				// 0000004165000000004165000000000000001697213
				// 8988801256656498SUPRIYADI 0902
				// JAKARTA9990000001089110518010001089110518
				// 00000172050000002500151895794 8988801089110518TANTY LESTARI
				// 0905 JAKARTA UTARA
				// 0000000510000000000510000000000000001895812
				// 8988801089110676RAHMAT ARIEF 1808 LUWU
				// 0000000800000000000800000000000000001891591
				// 8988801215305289SITI CARYATI 0903 JAKARTA TIMUR
				// 0000000425000000000425000000000000001891854
				// 8988801228222732SRI TITIEK INDRAWATI 0902 JAKARTA SELATAN
				// 0000000425000000000425000000000000001125877
				// 8988801255971971SDF 0401 PEKANBARU
				// 0000000935000000000935000000000000001696724
				// 8988801256652461HARYATI 1201 YOGYAKARTA
				// 0000002975000000002975000000000000001696957
				// 8988801256654248MA'MUROTUN 0902 JAKARTA SELATAN
				// 0000004165000000004165000000000000001697213
				// 8988801256656498SUPRIYADI 0902 JAKARTA");
				dataOutput.flush();
			} finally {
				// dataOutput.close();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}

		return null;
	}

	public static void main(String args[]) throws Exception {
		Provider server = new Provider();
		while (true) {
			server.run();
		}
	}

	// convert InputStream to String
	private static String getStringFromInputStream(InputStream is) {

		BufferedReader br = null;
		StringBuilder sb = new StringBuilder();

		String line;
		try {

			br = new BufferedReader(new InputStreamReader(is));
			while ((line = br.readLine()) != null) {
				sb.append(line);
			}

		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			if (br != null) {
				try {
					br.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}

		return sb.toString();
	}

	public static String readFully(InputStream input) {
		byte[] buffer;
		try {
			DataInputStream dataInput = new DataInputStream(input);
			try {
				buffer = new byte[dataInput.available()];
				dataInput.readFully(buffer);
				System.out.println("received : " + new String(buffer, 0, buffer.length - 0, "UTF-8"));
				return new String(buffer, 2, buffer.length - 2, "UTF-8");
			} finally {
				// dataInput.close();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}

		return null;
	}
	
	public static String readFully2 (InputStream input) throws IOException {
		DataInputStream in = new DataInputStream(input);
        int bytesRead = 0;

        byte[] messageByte = new byte[9680];
		messageByte[0] = in.readByte();
        messageByte[1] = in.readByte();
        ByteBuffer byteBuffer = ByteBuffer.wrap(messageByte, 0, 2);

        int bytesToRead = byteBuffer.getShort();
        
        
//        int off = 0;
//		byte[] b = new byte[135];
//		in.readFully(b, off, 135);
//        
//        System.out.println("About to read " + bytesToRead + " octets, messageByte length : " + new String(b));

        //The following code shows in detail how to read from a TCP socket

        boolean end = false;
		String messageString = "";
		while(!end)
        {
            bytesRead = in.read(messageByte);
            messageString += new String(messageByte, 0, bytesRead);
            if (messageString.length() == bytesToRead )
            {
                end = true;
            }
        }

        //All the code in the loop can be replaced by these two lines
        //in.readFully(messageByte, 0, bytesToRead);
        //messageString = new String(messageByte, 0, bytesToRead);

        System.out.println("MESSAGE: " + messageString);
		return messageString;
	}
	
	public static String writeFully3(OutputStream output, ISOMsg message) throws ISOException {
		
//		byte[] in = "0210723A40010AC180180613400317000000000002800000201707043675701432450704070560120300822548839025100DEVJATIS2009001008000001800000000062155293010000062155293   00000002550000002500011891288         8888800062155293RIZAL AN NAHL                 1005  SUKABUMI            000000025500000000025500000000000000360000000".getBytes();
//		byte[] msg = ISOHeader.join(ISOHeader.generateHeader(133).getBytes(), in);
		@SuppressWarnings("deprecation")
		ISOPackager p = new GenericPackager("fields.xml");
		ISOMsg iso2 = message;
		iso2.setPackager(p);
//		iso2.unpack(in);
//		iso2.setMTI("0210");
//		iso2.set(39,"34");
//		iso2.set(48, "");
//		byte[] buffer = "0210723A40010AC180180613400317000000000002800000201707071122331624470707070860120300887514961092200DEVJATIS2009001008000001800000000062155293010000062155293   00000002550000002500011891288         8888800062155293RIZAL AN NAHL                 1005  SUKABUMI            000000025500000000025500000000000000360000000"
//				.getBytes(StandardCharsets.UTF_8);
		
		byte[] buffer = iso2.pack();
		try {
			OutputStream dataOutput = output;
			try {
//				byte[] ss = ISOHeader.getTwoCharactersHeader();//ini udah jalan cuma 48 gak kebaca
				byte[] ss = ISOHeader.getTwoCharactersHeader(iso2);//ini terbaik
//				out.write("0210623A40010AC180180613400338000000201706228904902357380622061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA3609990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA9990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA".getBytes(), 0, "�0210623A40010AC180180613400338000000201706228904902357380622061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA3609990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA9990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA".getBytes().length);
//				byte[] mm = ISOHeader.join(ss, "0210623A40010AC180180613400338000000201706228904902357380622061560120300867581375865600DEVJATIS2009001008000009990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA3609990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA9990000001089110518010001089110518   00000172050000002500151895794         8988801089110518TANTY LESTARI                 0905  JAKARTA UTARA       0000000510000000000510000000000000001895812         8988801089110676RAHMAT ARIEF                  1808  LUWU                0000000800000000000800000000000000001891591         8988801215305289SITI CARYATI                  0903  JAKARTA TIMUR       0000000425000000000425000000000000001891854         8988801228222732SRI TITIEK INDRAWATI          0902  JAKARTA SELATAN     0000000425000000000425000000000000001125877         8988801255971971SDF                           0401  PEKANBARU           0000000935000000000935000000000000001696724         8988801256652461HARYATI                       1201  YOGYAKARTA          0000002975000000002975000000000000001696957         8988801256654248MA'MUROTUN                    0902  JAKARTA SELATAN     0000004165000000004165000000000000001697213         8988801256656498SUPRIYADI                     0902  JAKARTA".getBytes());
				byte[] mm = ISOHeader.join(ss, buffer);
				byte[] nn = ISOHeader.join(mm, "\u0003".getBytes(StandardCharsets.UTF_8));
				
				dataOutput.write(nn, 0, nn.length-0);
//				dataOutput.write(nn, 0, Integer.valueOf(new String(ss)));

//				dataOutput.write(ss);
				dataOutput.flush();
			} finally {
				// dataOutput.close();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}

		return null;
	}
}